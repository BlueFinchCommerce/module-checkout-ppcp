import{m as e,a as t,P as a,g as o,c as i,d as n,b as s,n as p,o as r}from"../../../PpcpStore-Dc8hu8rx.min.js";import{c as l,l as c}from"../../../createPPCPPaymentRest-DUkFikGQ.min.js";var d={name:"PpcpApplePay",data:()=>({applePayLoaded:!1,applePayConfig:null,key:"ppcpApplePay",method:"ppcp_applepay",orderID:null,applePayAvailable:!1,applePayTotal:"",dataCollectorInstance:null,shippingMethods:[],isEligible:!1}),computed:{...e(a,["apple","environment","buyerCountry","productionClientId","sandboxClientId"])},async created(){const[e,t,a]=await window.geneCheckout.helpers.loadFromCheckout(["stores.useCartStore","stores.usePaymentStore","stores.useConfigStore"]);t.addExpressMethod(this.key),await a.getInitialConfig(),await e.getCart(),this.apple.merchantName||await this.getInitialConfigValues();t.availableMethods.find((e=>e.code===this.method))?(await this.addSdkScript(),this.showApplePay()):(t.removeExpressMethod(this.key),this.applePayLoaded=!0)},methods:{...t(a,["getInitialConfigValues","makePayment","mapAppleAddress"]),async addSdkScript(){const e=await window.geneCheckout.helpers.loadFromCheckout(["stores.useConfigStore"]),t=c(),a={intent:this.apple.paymentAction,currency:e.currencyCode,components:"applepay"};"sandbox"===this.environment?(a["buyer-country"]=this.buyerCountry,a["client-id"]=this.sandboxClientId):a["client-id"]=this.productionClientId;try{await Promise.all([t("https://www.paypal.com/sdk/js",a,"ppcp_applepay"),t("https://applepay.cdn-apple.com/jsapi/v1.1.0/apple-pay-sdk.js",{},"")])}catch(e){throw console.error("Error loading SDK scripts:",e),new Error("Failed to load required SDK scripts.")}},showApplePay(){if(!window.ApplePaySession||!window.ApplePaySession.canMakePayments||"https:"!==window.location.protocol)return;this.applePayAvailable=!0;window[`paypal_${this.method}`].Applepay().config().then((e=>{this.applePayConfig=e,this.isEligible=!!e.isEligible,this.applePayLoaded=!0})).catch((()=>{console.error("Error while fetching Apple Pay configuration.")}))},async onClick(){const[e,t,a,o,i,n]=await window.geneCheckout.helpers.loadFromCheckout(["stores.useAgreementStore","stores.useCartStore","stores.useCustomerStore","stores.useConfigStore","stores.useLoadingStore","stores.usePaymentStore"]);n.setErrorMessage("");if(!e.validateAgreements())return;const s=window[`paypal_${this.method}`].Applepay();try{const e=["name","email","phone"];t.cart.is_virtual||e.push("postalAddress");const n={countryCode:o.countryCode,currencyCode:o.currencyCode,merchantCapabilities:this.applePayConfig.merchantCapabilities,supportedNetworks:this.applePayConfig.supportedNetworks,requiredShippingContactFields:e,requiredBillingContactFields:["postalAddress","name"],total:{label:this.apple.merchantName,amount:(t.cartGrandTotal/100).toString(),type:"final"}},p=new window.ApplePaySession(4,n);p.onvalidatemerchant=e=>{s.validateMerchant({validationUrl:e.validationURL}).then((e=>{p.completeMerchantValidation(e.merchantSession)})).catch((e=>{a.createNewAddress("shipping"),console.error(e),p.abort(),i.setLoadingState(!1)}))},t.cart.is_virtual||(p.onshippingcontactselected=e=>this.onShippingContactSelect(e,p),p.onshippingmethodselected=e=>this.onShippingMethodSelect(e,p)),p.oncancel=()=>{a.createNewAddress("shipping")},p.onpaymentauthorized=e=>this.onAuthorized(e,p),p.begin()}catch(e){a.createNewAddress("shipping"),await this.setApplePayError()}},async onAuthorized(e,t){const[a,o]=await window.geneCheckout.helpers.loadFromCheckout(["stores.useCartStore","stores.useConfigStore"]),i=window[`paypal_${this.method}`].Applepay(),{shippingContact:n,billingContact:s}=e.payment,p=n.emailAddress,r=n.phoneNumber,c=await this.mapAppleAddress(s,p,r);let d=null;if(a.cart.is_virtual||(d=await this.mapAppleAddress(n,p,r)),!o.countries.some((({id:e})=>e===c.country_code)))return void t.completePayment(window.ApplePaySession.STATUS_FAILURE);const h=await l(this.method);[this.orderID]=JSON.parse(h),i.confirmOrder({orderId:this.orderID,token:e.payment.token,billingContact:e.payment.billingContact}).then((async()=>{try{window.geneCheckout.services.setAddressesOnCart(d,c,p).then((()=>this.makePayment(p,this.orderID,this.method,!0))).then((async()=>{t.completePayment(window.ApplePaySession.STATUS_SUCCESS),window.location.href=window.geneCheckout.helpers.getSuccessPageUrl()}))}catch(e){console.log(e),t.completePayment(window.ApplePaySession.STATUS_FAILURE)}})).catch((e=>{e&&(console.error("Error confirming order with applepay token"),console.error(e),t.completePayment(window.ApplePaySession.STATUS_FAILURE))}))},async onShippingContactSelect(e,t){const[a,o,i]=await window.geneCheckout.helpers.loadFromCheckout(["stores.useCartStore","stores.useConfigStore","stores.useShippingMethodsStore"]),n={city:e.shippingContact.locality,company:"",region:e.shippingContact.administrativeArea,region_id:o.getRegionId(e.shippingContact.countryCode,e.shippingContact.administrativeArea),country_code:e.shippingContact.countryCode.toUpperCase(),postcode:e.shippingContact.postalCode,street:["0"],telephone:"000000000",firstname:"UNKNOWN",lastname:"UNKNOWN"};this.address=n;const s=(await window.geneCheckout.services.getShippingMethods(n,this.method,!0)).shipping_addresses[0].available_shipping_methods.filter((({method_code:e})=>"nominated_delivery"!==e));if(this.shippingMethods=s,!s.length){const e={errors:[new window.ApplePayError("addressUnserviceable","postalAddress",this.applePayNoShippingMethods)],newTotal:{label:o.websiteName,amount:"0.00",type:"pending"}};return void t.completeShippingContactSelection(e)}const p=s[0];await i.submitShippingInfo(p.carrier_code,p.method_code);const r={newShippingMethods:this.mapShippingMethods(s),newTotal:{label:this.applePayTotal,amount:parseFloat(a.cartGrandTotal/100).toFixed(2)},newLineItems:[{type:"final",label:"Subtotal",amount:a.cart.prices.subtotal_including_tax.value.toString()},{type:"final",label:"Shipping",amount:p.amount.value.toString()}]};a.cartDiscountTotal&&r.newLineItems.push({type:"final",label:"Discount",amount:a.cartDiscountTotal.toString()}),t.completeShippingContactSelection(r)},async onShippingMethodSelect(e,t){const[a,o]=await window.geneCheckout.helpers.loadFromCheckout(["stores.useCartStore","stores.useShippingMethodsStore"]),i=this.shippingMethods.find((({method_code:t})=>t===e.shippingMethod.identifier));await o.submitShippingInfo(i.carrier_code,i.method_code);const n={newTotal:{label:this.applePayTotal,amount:parseFloat(a.cartGrandTotal/100).toFixed(2)},newLineItems:[{type:"final",label:"Subtotal",amount:a.cart.prices.subtotal_including_tax.value.toString()},{type:"final",label:"Shipping",amount:i.amount.value.toString()}]};a.cartDiscountTotal&&n.newLineItems.push({type:"final",label:"Discount",amount:a.cartDiscountTotal.toString()}),t.completeShippingMethodSelection(n)},mapShippingMethods:e=>e.map((e=>({label:e.method_title,detail:e.carrier_title||"",amount:e.amount.value.toString(),identifier:e.method_code,carrierCode:e.carrier_code}))),async setApplePayError(){(await window.geneCheckout.helpers.loadFromCheckout(["stores.usePaymentStore"])).setErrorMessage("We're unable to take payments through Apple Pay at the moment. Please try an alternative payment method.")}}};d.render=function(e,t,a,l,c,d){const h=o("apple-pay-button");return c.applePayAvailable?(r(),i("div",{key:0,class:p(["ppcp-apple-pay-container",c.applePayLoaded?"ppcp-apple-pay":"text-loading"])},[c.applePayLoaded?(r(),n(h,{key:0,onClick:d.onClick,id:"ppcp-apple-pay",type:"buy",locale:"en"},null,8,["onClick"])):s("v-if",!0)],2)):s("v-if",!0)},d.__file="src/components/ExpressPayments/ApplePay/ApplePay.vue";export{d as default};

import{p as e}from"../../../index-BN2YhhzG.min.js";import{m as t,a as o,g as s,P as a,c as n,n as r,b as i,o as d}from"../../../createPPCPPaymentRest-DrWsrT7y.min.js";var c={name:"PpcpGooglePay",data:()=>({googlePayNoShippingMethods:"",googlePayLoaded:!1,googlePayConfig:null,key:"ppcpGooglePay",method:"ppcp_googlepay",orderID:null}),computed:{...t(a,["google","environment","buyerCountry","productionClientId","sandboxClientId"])},async created(){const[e,t,o]=await window.geneCheckout.helpers.loadFromCheckout(["stores.useCartStore","stores.usePaymentStore","stores.useConfigStore"]);t.addExpressMethod(this.key),await o.getInitialConfig(),await e.getCart(),await this.getInitialConfigValues();t.availableMethods.find((e=>e.code===this.method))?await this.initGooglePay():(t.removeExpressMethod(this.key),this.googlePayLoaded=!0)},methods:{...o(a,["getInitialConfigValues","getEnvironment","mapAddress","makePayment"]),async initGooglePay(){const[t,o]=await window.geneCheckout.helpers.loadFromCheckout(["stores.useCartStore","stores.useConfigStore"]),s={...{sandboxClientId:this.sandboxClientId,productionClientId:this.productionClientId,intent:this.google.paymentAction,pageType:"checkout",environment:this.environment,buyerCountry:this.buyerCountry,googlePayVersion:2,transactionInfo:{currencyCode:o.currencyCode,totalPriceStatus:"FINAL",totalPrice:(t.cartGrandTotal/100).toString()},button:{buttonColor:this.google.buttonColor.toLowerCase()}},...{placeOrder:e=>this.placeOrder(e),onPaymentAuthorized:(e,t)=>this.onPaymentAuthorized(e,t),onPaymentDataChanged:(e,t)=>this.onPaymentDataChanged(e,t),onError:e=>this.onError(e),onCancel:()=>this.onCancel(),onValidate:()=>this.onValidate()}};e.googlePayment(s,"ppcp-google-pay")},async onValidate(){const[e,t]=await window.geneCheckout.helpers.loadFromCheckout(["stores.useAgreementStore","stores.usePaymentStore"]);return t.setErrorMessage(""),e.validateAgreements()},async onError(e){const[t,o,s]=await window.geneCheckout.helpers.loadFromCheckout(["stores.useCustomerStore","stores.useLoadingStore","stores.usePaymentStore"]);t.createNewAddress("shipping"),o.setLoadingState(!1),s.setErrorMessage(e)},async onCancel(){const[e,t]=await window.geneCheckout.helpers.loadFromCheckout(["stores.useCustomerStore","stores.useLoadingStore"]);e.createNewAddress("shipping"),t.setLoadingState(!1)},async onPaymentDataChanged(e,t){const[o,s,a,n]=await window.geneCheckout.helpers.loadFromCheckout(["stores.useCartStore","stores.useConfigStore","stores.useLoadingStore","stores.useShippingMethodsStore"]);return o.cart.is_virtual?null:new Promise((r=>{const i={city:e.shippingAddress.locality,company:"",country_code:e.shippingAddress.countryCode,postcode:e.shippingAddress.postalCode,region:e.shippingAddress.administrativeArea,region_id:s.getRegionId(e.shippingAddress.countryCode,e.shippingAddress.administrativeArea),street:["0"],telephone:"000000000",firstname:"UNKNOWN",lastname:"UNKNOWN"};window.geneCheckout.services.getShippingMethods(i,this.method,!0).then((async s=>{const i=s.shipping_addresses[0].available_shipping_methods,d={},c=i.map((e=>{const t=e.carrier_title?`${window.geneCheckout.helpers.formatPrice(e.price_incl_tax.value)}\n                   ${e.carrier_title}`:window.geneCheckout.helpers.formatPrice(e.price_incl_tax.value);return{id:e.method_code,label:e.method_title,description:t}})).filter((e=>"nominated_delivery"!==e.id));if(!c.length)return void r({error:{reason:"SHIPPING_ADDRESS_UNSERVICEABLE",message:this.$t("errorMessages.googlePayNoShippingMethods"),intent:"SHIPPING_ADDRESS"}});const l="shipping_option_unselected"===e.shippingOptionData.id?i[0]:i.find((({method_code:t})=>t===e.shippingOptionData.id))||i[0];await n.submitShippingInfo(l.carrier_code,l.method_code),a.setLoadingState(!0),d.newShippingOptionParameters={defaultSelectedOptionId:l.method_code,shippingOptions:c},d.newTransactionInfo={displayItems:[{label:"Shipping",type:"LINE_ITEM",price:l.amount.value.toString(),status:"FINAL"}],currencyCode:o.cart.prices.grand_total.currency,totalPriceStatus:"FINAL",totalPrice:o.cart.prices.grand_total.value.toString(),totalPriceLabel:"Total",countryCode:t.countryCode},r(d)}))}))},async onPaymentAuthorized(e,t){const o=await window.geneCheckout.helpers.loadFromCheckout(["stores.useCartStore"]);return new Promise((async a=>{if(!o.cart.is_virtual&&!o.cart.shipping_addresses[0].selected_shipping_method)return void a({error:{reason:"SHIPPING_OPTION_INVALID",message:"No shipping method selected",intent:"SHIPPING_OPTION"}});const n=await this.mapAddress(e.paymentMethodData.info.billingAddress,e.email,e.paymentMethodData.info.billingAddress.phoneNumber);let r=null;o.cart.is_virtual||(r=await this.mapAddress(e.shippingAddress,e.email,e.shippingAddress.phoneNumber));try{await window.geneCheckout.services.setAddressesOnCart(r,n,e.email);const o=await s(this.method);[this.orderID]=JSON.parse(o);const i={orderId:this.orderID,paymentMethodData:e.paymentMethodData},d=await t.confirmOrder(i);await this.onApprove(d,e),a({transactionState:"SUCCESS"})}catch(e){a({error:{reason:"PAYMENT_DATA_INVALID",message:e.message,intent:"PAYMENT_AUTHORIZATION"}})}}))},async onApprove(e,t){if(e.liabilityShift&&"POSSIBLE"!==e.liabilityShift)throw new Error("Cannot validate payment");this.placeOrder(t)},async placeOrder(e){const[t,o,s]=await window.geneCheckout.helpers.loadFromCheckout(["stores.useLoadingStore","stores.useCustomerStore","stores.usePaymentStore"]);return this.makePayment(e.email,this.orderID,this.method,!0).then((()=>{window.location.href=window.geneCheckout.helpers.getSuccessPageUrl()})).catch((e=>{t.setLoadingState(!1);try{window.geneCheckout.helpers.handleServiceError(e)}catch(e){o.createNewAddress("shipping"),s.setErrorMessage(e)}}))}}};c.render=function(e,t,o,s,a,c){return e.google.enabled?(d(),n("div",{key:0,id:"ppcp-google-pay",class:r(a.googlePayLoaded?"":"text-loading"),"data-cy":"instant-checkout-PPCPGooglePay"},null,2)):i("v-if",!0)},c.__file="src/components/ExpressPayments/GooglePay/GooglePay.vue";export{c as default};

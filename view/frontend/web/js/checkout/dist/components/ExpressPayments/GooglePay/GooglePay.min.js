import{m as e,a as t,c as o,u as a,l as n,b as i,n as s,e as r,o as d}from"../../../createPPCPPaymentRest-BdrgOiHy.min.js";var l={name:"PpcpGooglePay",data:()=>({googlePayNoShippingMethods:"",googlePayLoaded:!1,googlePayConfig:null,key:"ppcpGooglePay",method:"ppcp_googlepay",orderID:null}),computed:{...e(a,["google","environment","buyerCountry","productionClientId","sandboxClientId"])},async created(){const[e,t,o]=await window.geneCheckout.helpers.loadFromCheckout(["stores.useCartStore","stores.usePaymentStore","stores.useConfigStore"]);t.addExpressMethod(this.key),await o.getInitialConfig(),await e.getCart(),await this.getInitialConfigValues();t.availableMethods.find((e=>e.code===this.method))?await this.initGooglePay():(t.removeExpressMethod(this.key),this.googlePayLoaded=!0)},mounted(){const e=document.createElement("script");e.setAttribute("src","https://pay.google.com/gp/p/js/pay.js"),document.head.appendChild(e)},methods:{...t(a,["getInitialConfigValues"]),async initGooglePay(){try{await this.addSdkScript();const e=await this.deviceSupported(),t=await this.createGooglePayClient(e),o=await this.createGooglePayButton(t);o&&(document.getElementById("ppcp-google-pay").appendChild(o),this.googlePayLoaded=!0)}catch(e){console.warn(e)}},async addSdkScript(){const e=await window.geneCheckout.helpers.loadFromCheckout(["stores.useConfigStore"]),t=n(),o={intent:this.google.paymentAction,currency:e.currencyCode,components:"googlepay"};return"sandbox"===this.environment?(o["buyer-country"]=this.buyerCountry,o["client-id"]=this.sandboxClientId):o["client-id"]=this.productionClientId,t("https://www.paypal.com/sdk/js",o,"ppcp_googlepay")},deviceSupported(){return new Promise(((e,t)=>{if("https:"!==window.location.protocol)return console.warn("Google Pay requires your checkout be served over HTTPS"),void t(new Error("Insecure protocol: HTTPS is required for Google Pay"));this.googlepay=window.paypal_ppcp_googlepay.Googlepay(),this.googlepay.config().then((async o=>{o.isEligible?(o.allowedPaymentMethods.forEach((e=>{e.parameters.billingAddressParameters.phoneNumberRequired=!0})),e(o)):t(new Error("Device not eligible for Google Pay"))})).catch((e=>{t(e)}))}))},createGooglePayClient(e){const t={onPaymentAuthorized:this.onPaymentAuthorized};return this.onPaymentDataChanged&&(t.onPaymentDataChanged=t=>this.onPaymentDataChanged(t,e)),this.googlePayClient=new window.google.payments.api.PaymentsClient({environment:this.getEnvironment(),paymentDataCallbacks:t}),this.googlePayClient.isReadyToPay({apiVersion:e.apiVersion,apiVersionMinor:e.apiVersionMinor,allowedPaymentMethods:e.allowedPaymentMethods}).then((t=>t.result?e:null))},createGooglePayButton(e){return this.googlePayClient.createButton({allowedPaymentMethods:e.allowedPaymentMethods,buttonColor:this.google.buttonColor.toLowerCase(),buttonSizeMode:"fill",onClick:()=>this.onClick(e)})},async onClick(e){const[t,o,a,n,i,s]=await window.geneCheckout.helpers.loadFromCheckout(["stores.useAgreementStore","stores.useCartStore","stores.useConfigStore","stores.useLoadingStore","stores.useShippingMethodsStore","stores.usePaymentStore"]);s.setErrorMessage("");if(!t.validateAgreements())return!1;i.setNotClickAndCollect();const r={...e},d=["PAYMENT_AUTHORIZATION"],l=this.onPaymentDataChanged&&!o.cart.is_virtual;return l&&d.push("SHIPPING_ADDRESS","SHIPPING_OPTION"),r.allowedPaymentMethods=e.allowedPaymentMethods,r.transactionInfo={countryCode:e.countryCode,currencyCode:a.currencyCode,totalPriceStatus:"FINAL",totalPrice:(o.cartGrandTotal/100).toString()},r.merchantInfo=e.merchantInfo,r.shippingAddressRequired=l,r.shippingAddressParameters={phoneNumberRequired:l},r.emailRequired=!0,r.shippingOptionRequired=l,r.callbackIntents=d,delete r.countryCode,delete r.isEligible,n.setLoadingState(!0),this.googlePayClient.loadPaymentData(r).catch((e=>{console.warn(e)}))},async onPaymentDataChanged(e,t){const[o,a,n,i]=await window.geneCheckout.helpers.loadFromCheckout(["stores.useCartStore","stores.useConfigStore","stores.useLoadingStore","stores.useShippingMethodsStore"]);return new Promise((s=>{const r={city:e.shippingAddress.locality,company:"",country_code:e.shippingAddress.countryCode,postcode:e.shippingAddress.postalCode,region:e.shippingAddress.administrativeArea,region_id:a.getRegionId(e.shippingAddress.countryCode,e.shippingAddress.administrativeArea),street:["0"],telephone:"000000000",firstname:"UNKNOWN",lastname:"UNKNOWN"};window.geneCheckout.services.getShippingMethods(r,this.method,!0).then((async a=>{const r=a.shipping_addresses[0].available_shipping_methods,d={},l=r.map((e=>{const t=e.carrier_title?`${window.geneCheckout.helpers.formatPrice(e.price_incl_tax.value)}\n                   ${e.carrier_title}`:window.geneCheckout.helpers.formatPrice(e.price_incl_tax.value);return{id:e.method_code,label:e.method_title,description:t}})).filter((e=>"nominated_delivery"!==e.id));if(!l.length)return void s({error:{reason:"SHIPPING_ADDRESS_UNSERVICEABLE",message:this.$t("errorMessages.googlePayNoShippingMethods"),intent:"SHIPPING_ADDRESS"}});const c="shipping_option_unselected"===e.shippingOptionData.id?r[0]:r.find((({method_code:t})=>t===e.shippingOptionData.id))||r[0];await i.submitShippingInfo(c.carrier_code,c.method_code),n.setLoadingState(!0),d.newShippingOptionParameters={defaultSelectedOptionId:c.method_code,shippingOptions:l},d.newTransactionInfo={displayItems:[{label:"Shipping",type:"LINE_ITEM",price:c.amount.value.toString(),status:"FINAL"}],currencyCode:o.cart.prices.grand_total.currency,totalPriceStatus:"FINAL",totalPrice:o.cart.prices.grand_total.value.toString(),totalPriceLabel:"Total",countryCode:t.countryCode},s(d)}))}))},async onPaymentAuthorized(e){const t=await window.geneCheckout.helpers.loadFromCheckout(["stores.useCartStore"]);return new Promise((async a=>{if(!t.cart.is_virtual&&!t.cart.shipping_addresses[0].selected_shipping_method)return void a({error:{reason:"SHIPPING_OPTION_INVALID",message:"No shipping method selected",intent:"SHIPPING_OPTION"}});const n=await this.mapAddress(e.paymentMethodData.info.billingAddress,e.email,e.paymentMethodData.info.billingAddress.phoneNumber);let i=null;t.cart.is_virtual||(i=await this.mapAddress(e.shippingAddress,e.email,e.shippingAddress.phoneNumber));try{await window.geneCheckout.services.setAddressesOnCart(i,n,e.email);const t=await o(this.method);[this.orderID]=JSON.parse(t);const s={orderId:this.orderID,paymentMethodData:e.paymentMethodData},r=await this.googlepay.confirmOrder(s);await this.onApprove(r,e),a({transactionState:"SUCCESS"})}catch(e){a({error:{reason:"PAYMENT_DATA_INVALID",message:e.message,intent:"PAYMENT_AUTHORIZATION"}})}}))},async onApprove(e,t){const[o,a,n]=await window.geneCheckout.helpers.loadFromCheckout(["stores.useLoadingStore","stores.useCustomerStore","stores.usePaymentStore"]);if(e.liabilityShift&&"POSSIBLE"!==e.liabilityShift)throw new Error("Cannot validate payment");return this.makePayment(t).then((()=>window.geneCheckout.services.refreshCustomerData(["cart"]))).then((()=>{window.location.href=window.geneCheckout.helpers.getSuccessPageUrl()})).catch((e=>{o.setLoadingState(!1);try{window.geneCheckout.helpers.handleServiceError(e)}catch(e){a.createNewAddress("shipping"),n.setErrorMessage(e)}}))},async makePayment(e){const t={email:e.email,paymentMethod:{method:this.method,additional_data:{"express-payment":!0,"paypal-order-id":this.orderID},extension_attributes:window.geneCheckout.helpers.getPaymentExtensionAttributes()}};return window.geneCheckout.services.createPaymentRest(t)},getEnvironment(){return"sandbox"===this.environment?"TEST":"PRODUCTION"},async mapAddress(e,t,o){const a=await window.geneCheckout.helpers.loadFromCheckout(["stores.useConfigStore"]),[n,...i]=e.name.split(" "),s=a.getRegionId(e.countryCode,e.administrativeArea);return{street:[e.address1,e.address2],postcode:e.postalCode,country_code:e.countryCode,company:e.company||"",email:t,firstname:n,lastname:i.length?i.join(" "):"UNKNOWN",city:e.locality,telephone:o,region:{...e.administrativeArea?{region:e.administrativeArea}:{},...s?{region_id:s}:{}}}}}};l.render=function(e,t,o,a,n,l){return e.google.enabled?(d(),i("div",{key:0,id:"ppcp-google-pay",class:s(n.googlePayLoaded?"":"text-loading"),"data-cy":"instant-checkout-PPCPGooglePay"},null,2)):r("v-if",!0)},l.__file="src/components/ExpressPayments/GooglePay/GooglePay.vue";export{l as default};

import{p as e}from"../../../index-qW3CXwUR.min.js";import{m as t,P as o,a as r,c as s,b as i,o as a,n,h as d}from"../../../PpcpStore-on2nz2kl.min.js";import{c}from"../../../createPPCPPaymentRest-GBVR1Bbe.min.js";var h={name:"PpcpGooglePay",data:()=>({googlePayNoShippingMethods:"",googlePayLoaded:!1,googlePayConfig:null,key:"ppcpGooglePay",method:"ppcp_googlepay",orderID:null}),computed:{...r(o,["google","environment","buyerCountry","productionClientId","sandboxClientId"])},async created(){const[e,t,o]=await window.bluefinchCheckout.helpers.loadFromCheckout(["stores.useCartStore","stores.usePaymentStore","stores.useConfigStore"]);t.addExpressMethod(this.key),await o.getInitialConfig(),await e.getCart(),await this.getInitialConfigValues();t.availableMethods.find((e=>e.code===this.method))&&this.google.showOnTopCheckout?await this.initGooglePay():(t.removeExpressMethod(this.key),this.googlePayLoaded=!0)},methods:{...t(o,["getInitialConfigValues","getEnvironment","mapAddress","makePayment"]),async initGooglePay(){const[t,o]=await window.bluefinchCheckout.helpers.loadFromCheckout(["stores.useCartStore","stores.useConfigStore"]),r={...{sandboxClientId:this.sandboxClientId,productionClientId:this.productionClientId,intent:this.google.paymentAction,pageType:"checkout",environment:this.environment,buyerCountry:this.buyerCountry,googlePayVersion:2,transactionInfo:{currencyCode:o.currencyCode,totalPriceStatus:"FINAL",totalPrice:(t.cartGrandTotal/100).toString()},button:{buttonColor:this.google.buttonColor.toLowerCase()}},...{placeOrder:e=>this.placeOrder(e),onPaymentAuthorized:(e,t)=>this.onPaymentAuthorized(e,t),...t.cart.is_virtual?{}:{onPaymentDataChanged:(e,t)=>this.onPaymentDataChanged(e,t)},onError:e=>this.onError(e),onCancel:()=>this.onCancel(),onValidate:()=>this.onValidate()}};e.googlePayment(r,"ppcp-google-pay")},async onValidate(){const[e,t]=await window.bluefinchCheckout.helpers.loadFromCheckout(["stores.useAgreementStore","stores.usePaymentStore"]);return t.setErrorMessage(""),e.validateAgreements()},async onError(e){const[t,o,r]=await window.bluefinchCheckout.helpers.loadFromCheckout(["stores.useCustomerStore","stores.useLoadingStore","stores.usePaymentStore"]);t.createNewAddress("shipping"),o.setLoadingState(!1),r.setErrorMessage(e)},async onCancel(){const[e,t]=await window.bluefinchCheckout.helpers.loadFromCheckout(["stores.useCustomerStore","stores.useLoadingStore"]);e.createNewAddress("shipping"),t.setLoadingState(!1)},async onPaymentDataChanged(e,t){const[o,r,s,i]=await window.bluefinchCheckout.helpers.loadFromCheckout(["stores.useCartStore","stores.useConfigStore","stores.useLoadingStore","stores.useShippingMethodsStore"]);return o.cart.is_virtual?null:new Promise((a=>{const n={city:e.shippingAddress.locality,company:"",country_code:e.shippingAddress.countryCode,postcode:e.shippingAddress.postalCode,region:e.shippingAddress.administrativeArea,region_id:r.getRegionId(e.shippingAddress.countryCode,e.shippingAddress.administrativeArea),street:["0"],telephone:"000000000",firstname:"UNKNOWN",lastname:"UNKNOWN"};window.bluefinchCheckout.services.getShippingMethods(n,this.method,!0).then((async r=>{try{const n=r.shipping_addresses[0].available_shipping_methods,d={},c=n.map((e=>{const t=e.carrier_title?`${window.bluefinchCheckout.helpers.formatPrice(e.price_incl_tax.value)}\n             ${e.carrier_title}`:window.bluefinchCheckout.helpers.formatPrice(e.price_incl_tax.value);return{id:e.method_code,label:e.method_title,description:t}})).filter((e=>"nominated_delivery"!==e.id));if(!c.length)return void a({error:{reason:"SHIPPING_ADDRESS_UNSERVICEABLE",message:this.$t("errorMessages.googlePayNoShippingMethods"),intent:"SHIPPING_ADDRESS"}});const h="shipping_option_unselected"===e.shippingOptionData.id?n[0]:n.find((({method_code:t})=>t===e.shippingOptionData.id))||n[0];await i.submitShippingInfo(h.carrier_code,h.method_code),s.setLoadingState(!0),d.newShippingOptionParameters={defaultSelectedOptionId:h.method_code,shippingOptions:c},d.newTransactionInfo={displayItems:[{label:"Shipping",type:"LINE_ITEM",price:h.amount.value.toString(),status:"FINAL"}],currencyCode:o.cart.prices.grand_total.currency,totalPriceStatus:"FINAL",totalPrice:o.cart.prices.grand_total.value.toString(),totalPriceLabel:"Total",countryCode:t.countryCode},a(d)}catch(e){console.error("Error processing shipping methods:",e),a({error:{reason:"INTERNAL_ERROR",message:this.$t("errorMessages.unexpectedError"),intent:"SHIPPING_ADDRESS"}})}})).catch((e=>{console.error("Error fetching shipping methods:",e),a({error:{reason:"SHIPPING_ADDRESS_UNSERVICEABLE",message:this.$t("errorMessages.googlePayNoShippingMethods"),intent:"SHIPPING_ADDRESS"}})}))}))},async onPaymentAuthorized(e,t){const o=await window.bluefinchCheckout.helpers.loadFromCheckout(["stores.useCartStore"]);return new Promise((async r=>{if(!o.cart.is_virtual&&!o.cart.shipping_addresses[0].selected_shipping_method)return void r({error:{reason:"SHIPPING_OPTION_INVALID",message:"No shipping method selected",intent:"SHIPPING_OPTION"}});const s=await this.mapAddress(e.paymentMethodData.info.billingAddress,e.email,e.paymentMethodData.info.billingAddress.phoneNumber);let i=null;o.cart.is_virtual||(i=await this.mapAddress(e.shippingAddress,e.email,e.shippingAddress.phoneNumber));try{await window.bluefinchCheckout.services.setAddressesOnCart(i,s,e.email);const o=await c(this.method);[this.orderID]=JSON.parse(o);const a={orderId:this.orderID,paymentMethodData:e.paymentMethodData},n=await t.confirmOrder(a);await this.onApprove(n,e),r({transactionState:"SUCCESS"})}catch(e){r({error:{reason:"PAYMENT_DATA_INVALID",message:e.message,intent:"PAYMENT_AUTHORIZATION"}})}}))},async onApprove(e,t){if(e.liabilityShift&&"POSSIBLE"!==e.liabilityShift)throw new Error("Cannot validate payment");this.placeOrder(t)},async placeOrder(e){const[t,o,r]=await window.bluefinchCheckout.helpers.loadFromCheckout(["stores.useLoadingStore","stores.useCustomerStore","stores.usePaymentStore"]);return this.makePayment(e.email,this.orderID,this.method,!0).then((()=>{window.location.href=window.bluefinchCheckout.helpers.getSuccessPageUrl()})).catch((e=>{t.setLoadingState(!1);try{window.bluefinchCheckout.helpers.handleServiceError(e)}catch(e){o.createNewAddress("shipping"),r.setErrorMessage(e)}}))}}};h.render=function(e,t,o,r,c,h){return e.google.enabled&&e.google.showOnTopCheckout?(a(),s("div",{key:0,id:"ppcp-google-pay",style:d({order:e.google.sortOrder}),class:n(c.googlePayLoaded?"":"text-loading"),"data-cy":"instant-checkout-PPCPGooglePay"},null,6)):i("v-if",!0)},h.__file="src/components/ExpressPayments/GooglePay/GooglePay.vue";export{h as default};

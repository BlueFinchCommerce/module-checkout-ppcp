import{p as e}from"../../../index-Dbrmc3_a.min.js";import{m as t,a as o,P as s,c as r,n as a,b as n,o as i}from"../../../PpcpStore-cIPv95xA.min.js";import{c as d}from"../../../createPPCPPaymentRest-ClXvBo5i.min.js";var c={name:"PpcpGooglePay",data:()=>({googlePayNoShippingMethods:"",googlePayLoaded:!1,googlePayConfig:null,key:"ppcpGooglePay",method:"ppcp_googlepay",orderID:null}),computed:{...t(s,["google","environment","buyerCountry","productionClientId","sandboxClientId"])},async created(){const[e,t,o]=await window.geneCheckout.helpers.loadFromCheckout(["stores.useCartStore","stores.usePaymentStore","stores.useConfigStore"]);t.addExpressMethod(this.key),await o.getInitialConfig(),await e.getCart(),await this.getInitialConfigValues();t.availableMethods.find((e=>e.code===this.method))&&this.google.showOnTopCheckout?await this.initGooglePay():(t.removeExpressMethod(this.key),this.googlePayLoaded=!0)},methods:{...o(s,["getInitialConfigValues","getEnvironment","mapAddress","makePayment"]),async initGooglePay(){const[t,o]=await window.geneCheckout.helpers.loadFromCheckout(["stores.useCartStore","stores.useConfigStore"]),s={...{sandboxClientId:this.sandboxClientId,productionClientId:this.productionClientId,intent:this.google.paymentAction,pageType:"checkout",environment:this.environment,buyerCountry:this.buyerCountry,googlePayVersion:2,transactionInfo:{currencyCode:o.currencyCode,totalPriceStatus:"FINAL",totalPrice:(t.cartGrandTotal/100).toString()},button:{buttonColor:this.google.buttonColor.toLowerCase()}},...{placeOrder:e=>this.placeOrder(e),onPaymentAuthorized:(e,t)=>this.onPaymentAuthorized(e,t),...t.cart.is_virtual?{}:{onPaymentDataChanged:(e,t)=>this.onPaymentDataChanged(e,t)},onError:e=>this.onError(e),onCancel:()=>this.onCancel(),onValidate:()=>this.onValidate()}};e.googlePayment(s,"ppcp-google-pay")},async onValidate(){const[e,t]=await window.geneCheckout.helpers.loadFromCheckout(["stores.useAgreementStore","stores.usePaymentStore"]);return t.setErrorMessage(""),e.validateAgreements()},async onError(e){const[t,o,s]=await window.geneCheckout.helpers.loadFromCheckout(["stores.useCustomerStore","stores.useLoadingStore","stores.usePaymentStore"]);t.createNewAddress("shipping"),o.setLoadingState(!1),s.setErrorMessage(e)},async onCancel(){const[e,t]=await window.geneCheckout.helpers.loadFromCheckout(["stores.useCustomerStore","stores.useLoadingStore"]);e.createNewAddress("shipping"),t.setLoadingState(!1)},async onPaymentDataChanged(e,t){const[o,s,r,a]=await window.geneCheckout.helpers.loadFromCheckout(["stores.useCartStore","stores.useConfigStore","stores.useLoadingStore","stores.useShippingMethodsStore"]);return o.cart.is_virtual?null:new Promise((n=>{const i={city:e.shippingAddress.locality,company:"",country_code:e.shippingAddress.countryCode,postcode:e.shippingAddress.postalCode,region:e.shippingAddress.administrativeArea,region_id:s.getRegionId(e.shippingAddress.countryCode,e.shippingAddress.administrativeArea),street:["0"],telephone:"000000000",firstname:"UNKNOWN",lastname:"UNKNOWN"};window.geneCheckout.services.getShippingMethods(i,this.method,!0).then((async s=>{try{const i=s.shipping_addresses[0].available_shipping_methods,d={},c=i.map((e=>{const t=e.carrier_title?`${window.geneCheckout.helpers.formatPrice(e.price_incl_tax.value)}\n             ${e.carrier_title}`:window.geneCheckout.helpers.formatPrice(e.price_incl_tax.value);return{id:e.method_code,label:e.method_title,description:t}})).filter((e=>"nominated_delivery"!==e.id));if(!c.length)return void n({error:{reason:"SHIPPING_ADDRESS_UNSERVICEABLE",message:this.$t("errorMessages.googlePayNoShippingMethods"),intent:"SHIPPING_ADDRESS"}});const h="shipping_option_unselected"===e.shippingOptionData.id?i[0]:i.find((({method_code:t})=>t===e.shippingOptionData.id))||i[0];await a.submitShippingInfo(h.carrier_code,h.method_code),r.setLoadingState(!0),d.newShippingOptionParameters={defaultSelectedOptionId:h.method_code,shippingOptions:c},d.newTransactionInfo={displayItems:[{label:"Shipping",type:"LINE_ITEM",price:h.amount.value.toString(),status:"FINAL"}],currencyCode:o.cart.prices.grand_total.currency,totalPriceStatus:"FINAL",totalPrice:o.cart.prices.grand_total.value.toString(),totalPriceLabel:"Total",countryCode:t.countryCode},n(d)}catch(e){console.error("Error processing shipping methods:",e),n({error:{reason:"INTERNAL_ERROR",message:this.$t("errorMessages.unexpectedError"),intent:"SHIPPING_ADDRESS"}})}})).catch((e=>{console.error("Error fetching shipping methods:",e),n({error:{reason:"SHIPPING_ADDRESS_UNSERVICEABLE",message:this.$t("errorMessages.googlePayNoShippingMethods"),intent:"SHIPPING_ADDRESS"}})}))}))},async onPaymentAuthorized(e,t){const o=await window.geneCheckout.helpers.loadFromCheckout(["stores.useCartStore"]);return new Promise((async s=>{if(!o.cart.is_virtual&&!o.cart.shipping_addresses[0].selected_shipping_method)return void s({error:{reason:"SHIPPING_OPTION_INVALID",message:"No shipping method selected",intent:"SHIPPING_OPTION"}});const r=await this.mapAddress(e.paymentMethodData.info.billingAddress,e.email,e.paymentMethodData.info.billingAddress.phoneNumber);let a=null;o.cart.is_virtual||(a=await this.mapAddress(e.shippingAddress,e.email,e.shippingAddress.phoneNumber));try{await window.geneCheckout.services.setAddressesOnCart(a,r,e.email);const o=await d(this.method);[this.orderID]=JSON.parse(o);const n={orderId:this.orderID,paymentMethodData:e.paymentMethodData},i=await t.confirmOrder(n);await this.onApprove(i,e),s({transactionState:"SUCCESS"})}catch(e){s({error:{reason:"PAYMENT_DATA_INVALID",message:e.message,intent:"PAYMENT_AUTHORIZATION"}})}}))},async onApprove(e,t){if(e.liabilityShift&&"POSSIBLE"!==e.liabilityShift)throw new Error("Cannot validate payment");this.placeOrder(t)},async placeOrder(e){const[t,o,s]=await window.geneCheckout.helpers.loadFromCheckout(["stores.useLoadingStore","stores.useCustomerStore","stores.usePaymentStore"]);return this.makePayment(e.email,this.orderID,this.method,!0).then((()=>{window.location.href=window.geneCheckout.helpers.getSuccessPageUrl()})).catch((e=>{t.setLoadingState(!1);try{window.geneCheckout.helpers.handleServiceError(e)}catch(e){o.createNewAddress("shipping"),s.setErrorMessage(e)}}))}}};c.render=function(e,t,o,s,d,c){return e.google.enabled&&e.google.showOnTopCheckout?(i(),r("div",{key:0,id:"ppcp-google-pay",class:a(d.googlePayLoaded?"":"text-loading"),"data-cy":"instant-checkout-PPCPGooglePay"},null,2)):n("v-if",!0)},c.__file="src/components/ExpressPayments/GooglePay/GooglePay.vue";export{c as default};

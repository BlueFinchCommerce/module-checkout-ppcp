import{m as e,a as t,c as o,u as n,l as a}from"../../../createPPCPPaymentRest-CrTWX_Ft.min.js";import{c as i,n as r,o as s}from"../../../runtime-core.esm-bundler-BiH3XK8_.min.js";var d={name:"PpcpGooglePay",data:()=>({googlePayNoShippingMethods:"",googlePayLoaded:!1,googlePayConfig:null,key:"ppcpGooglePay",method:"ppcp_googlepay",orderID:null}),computed:{...e(n,["google","environment","buyerCountry","productionClientId","sandboxClientId"])},async created(){const[e,t,o]=await window.geneCheckout.helpers.loadFromCheckout(["stores.useCartStore","stores.usePaymentStore","stores.useConfigStore"]);t.addExpressMethod(this.key),await o.getInitialConfig(),await e.getCart(),await this.getInitialConfigValues(),await this.initGooglePay()},mounted(){const e=document.createElement("script");e.setAttribute("src","https://pay.google.com/gp/p/js/pay.js"),document.head.appendChild(e)},methods:{...t(n,["getInitialConfigValues"]),async initGooglePay(){try{await this.addSdkScript();const e=await this.deviceSupported(),t=await this.createGooglePayClient(e),o=await this.createGooglePayButton(t);o&&(document.getElementById("ppcp-google-pay").appendChild(o),this.googlePayLoaded=!0)}catch(e){console.warn(e)}},async addSdkScript(){const e=await window.geneCheckout.helpers.loadFromCheckout(["stores.useConfigStore"]),t=a(),o={intent:this.google.paymentAction,currency:e.currencyCode,components:"googlepay"};return"sandbox"===this.environment?(o["buyer-country"]=this.buyerCountry,o["client-id"]=this.sandboxClientId):o["client-id"]=this.productionClientId,t("https://www.paypal.com/sdk/js",o,"ppcp_googlepay")},deviceSupported(){return new Promise(((e,t)=>{if("https:"!==window.location.protocol)return console.warn("Google Pay requires your checkout be served over HTTPS"),void t(new Error("Insecure protocol: HTTPS is required for Google Pay"));this.googlepay=window.paypal_ppcp_googlepay.Googlepay(),this.googlepay.config().then((async o=>{o.isEligible?(o.allowedPaymentMethods.forEach((e=>{e.parameters.billingAddressParameters.phoneNumberRequired=!0})),e(o)):t(new Error("Device not eligible for Google Pay"))})).catch((e=>{t(e)}))}))},createGooglePayClient(e){const t={onPaymentAuthorized:this.onPaymentAuthorized};return this.onPaymentDataChanged&&(t.onPaymentDataChanged=t=>this.onPaymentDataChanged(t,e)),this.googlePayClient=new window.google.payments.api.PaymentsClient({environment:this.getEnvironment(),paymentDataCallbacks:t}),this.googlePayClient.isReadyToPay({apiVersion:e.apiVersion,apiVersionMinor:e.apiVersionMinor,allowedPaymentMethods:e.allowedPaymentMethods}).then((t=>t.result?e:null))},createGooglePayButton(e){return this.googlePayClient.createButton({allowedPaymentMethods:e.allowedPaymentMethods,buttonColor:this.google.buttonColor.toLowerCase(),buttonSizeMode:"fill",onClick:()=>this.onClick(e)})},async onClick(e){const[t,o,n,a,i,r]=await window.geneCheckout.helpers.loadFromCheckout(["stores.useAgreementStore","stores.useCartStore","stores.useConfigStore","stores.useLoadingStore","stores.useShippingMethodsStore","stores.usePaymentStore"]);r.setErrorMessage("");if(!t.validateAgreements())return!1;i.setNotClickAndCollect();const s={...e},d=["PAYMENT_AUTHORIZATION"],l=this.onPaymentDataChanged&&!o.cart.is_virtual;return l&&d.push("SHIPPING_ADDRESS","SHIPPING_OPTION"),s.allowedPaymentMethods=e.allowedPaymentMethods,s.transactionInfo={countryCode:e.countryCode,currencyCode:n.currencyCode,totalPriceStatus:"FINAL",totalPrice:(o.cartGrandTotal/100).toString()},s.merchantInfo=e.merchantInfo,s.shippingAddressRequired=l,s.shippingAddressParameters={phoneNumberRequired:l},s.emailRequired=!0,s.shippingOptionRequired=l,s.callbackIntents=d,delete s.countryCode,delete s.isEligible,a.setLoadingState(!0),this.googlePayClient.loadPaymentData(s).catch((e=>{console.warn(e)}))},async onPaymentDataChanged(e,t){const[o,n,a,i]=await window.geneCheckout.helpers.loadFromCheckout(["stores.useCartStore","stores.useConfigStore","stores.useLoadingStore","stores.useShippingMethodsStore"]);return new Promise((r=>{const s={city:e.shippingAddress.locality,company:"",country_code:e.shippingAddress.countryCode,postcode:e.shippingAddress.postalCode,region:e.shippingAddress.administrativeArea,region_id:n.getRegionId(e.shippingAddress.countryCode,e.shippingAddress.administrativeArea),street:["0"],telephone:"000000000",firstname:"UNKNOWN",lastname:"UNKNOWN"};window.geneCheckout.services.getShippingMethods(s,this.method,!0).then((async n=>{const s=n.shipping_addresses[0].available_shipping_methods,d={},l=s.map((e=>{const t=e.carrier_title?`${window.geneCheckout.helpers.formatPrice(e.price_incl_tax.value)}\n                   ${e.carrier_title}`:window.geneCheckout.helpers.formatPrice(e.price_incl_tax.value);return{id:e.method_code,label:e.method_title,description:t}})).filter((e=>"nominated_delivery"!==e.id));if(!l.length)return void r({error:{reason:"SHIPPING_ADDRESS_UNSERVICEABLE",message:this.$t("errorMessages.googlePayNoShippingMethods"),intent:"SHIPPING_ADDRESS"}});const c="shipping_option_unselected"===e.shippingOptionData.id?s[0]:s.find((({method_code:t})=>t===e.shippingOptionData.id))||s[0];await i.submitShippingInfo(c.carrier_code,c.method_code),a.setLoadingState(!0),d.newShippingOptionParameters={defaultSelectedOptionId:c.method_code,shippingOptions:l},d.newTransactionInfo={displayItems:[{label:"Shipping",type:"LINE_ITEM",price:c.amount.value.toString(),status:"FINAL"}],currencyCode:o.cart.prices.grand_total.currency,totalPriceStatus:"FINAL",totalPrice:o.cart.prices.grand_total.value.toString(),totalPriceLabel:"Total",countryCode:t.countryCode},r(d)}))}))},async onPaymentAuthorized(e){const t=await window.geneCheckout.helpers.loadFromCheckout(["stores.useCartStore"]);return new Promise((async n=>{if(!t.cart.is_virtual&&!t.cart.shipping_addresses[0].selected_shipping_method)return void n({error:{reason:"SHIPPING_OPTION_INVALID",message:"No shipping method selected",intent:"SHIPPING_OPTION"}});const a=await this.mapAddress(e.paymentMethodData.info.billingAddress,e.email,e.paymentMethodData.info.billingAddress.phoneNumber);let i=null;t.cart.is_virtual||(i=await this.mapAddress(e.shippingAddress,e.email,e.shippingAddress.phoneNumber));try{await window.geneCheckout.services.setAddressesOnCart(i,a,e.email);const t=await o(this.method);[this.orderID]=JSON.parse(t);const r={orderId:this.orderID,paymentMethodData:e.paymentMethodData},s=await this.googlepay.confirmOrder(r);await this.onApprove(s,e),n({transactionState:"SUCCESS"})}catch(e){n({error:{reason:"PAYMENT_DATA_INVALID",message:e.message,intent:"PAYMENT_AUTHORIZATION"}})}}))},async onApprove(e,t){const[o,n,a]=await window.geneCheckout.helpers.loadFromCheckout(["stores.useLoadingStore","stores.useCustomerStore","stores.usePaymentStore"]);if(e.liabilityShift&&"POSSIBLE"!==e.liabilityShift)throw new Error("Cannot validate payment");return this.makePayment(t).then((()=>window.geneCheckout.services.refreshCustomerData(["cart"]))).then((()=>{window.location.href=window.geneCheckout.helpers.getSuccessPageUrl()})).catch((e=>{o.setLoadingState(!1);try{window.geneCheckout.helpers.handleServiceError(e)}catch(e){n.createNewAddress("shipping"),a.setErrorMessage(e)}}))},async makePayment(e){const t={email:e.email,paymentMethod:{method:this.method,additional_data:{"express-payment":!0,"paypal-order-id":this.orderID},extension_attributes:window.geneCheckout.helpers.getPaymentExtensionAttributes()}};return window.geneCheckout.services.createPaymentRest(t)},getEnvironment(){return"sandbox"===this.environment?"TEST":"PRODUCTION"},async mapAddress(e,t,o){const n=await window.geneCheckout.helpers.loadFromCheckout(["stores.useConfigStore"]),[a,...i]=e.name.split(" "),r=n.getRegionId(e.countryCode,e.administrativeArea);return{street:[e.address1,e.address2],postcode:e.postalCode,country_code:e.countryCode,company:e.company||"",email:t,firstname:a,lastname:i.length?i.join(" "):"UNKNOWN",city:e.locality,telephone:o,region:{...e.administrativeArea?{region:e.administrativeArea}:{},...r?{region_id:r}:{}}}}}};d.render=function(e,t,o,n,a,d){return s(),i("div",{id:"ppcp-google-pay",class:r(a.googlePayLoaded?"":"text-loading"),"data-cy":"instant-checkout-PPCPGooglePay"},null,2)},d.__file="src/components/ExpressPayments/GooglePay/GooglePay.vue";export{d as default};

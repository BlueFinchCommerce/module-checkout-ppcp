import{p as e}from"../../../../index-T5r878YG.min.js";import{m as t,a,u as o,c as s,r as n,F as r,o as i,n as d,d as l,e as c,g as p,b as m,h}from"../../../../PpcpStore-DYS7Ru-W.min.js";import{c as u}from"../../../../createPPCPPaymentRest-yGi_DQF0.min.js";var y={name:"PpcpApmPayment",props:{open:{type:Boolean,required:!1}},data:()=>({selectedMethod:null,apmPaymentLoaded:!1,allowedMethods:{},errorMessage:"",ErrorMessage:null,PrivacyPolicy:null,RadioButton:null,Recaptcha:null,Agreements:null,isRecaptchaVisible:()=>{},orderID:null,availableMethods:[]}),computed:{...t(o,["apm","environment","buyerCountry","productionClientId","sandboxClientId"])},watch:{selectedMethod:{handler(e){null!==e&&(this.selectedMethod=e)},immediate:!0,deep:!0}},async mounted(){const{default:{components:{ErrorMessage:e,PrivacyPolicy:t,RadioButton:a,Recaptcha:o,Agreements:s}}}=await import(window.geneCheckout.main);this.Agreements=s,this.ErrorMessage=e,this.RadioButton=a,this.Recaptcha=o,this.PrivacyPolicy=t},async created(){const[e,t,a,o]=await window.geneCheckout.helpers.loadFromCheckout(["stores.useRecaptchaStore","stores.usePaymentStore","stores.useConfigStore","stores.useCartStore"]);this.isRecaptchaVisible=e.isRecaptchaVisible,t.$subscribe((e=>{void 0!==e.payload.selectedMethod&&(this.selectedMethod=e.payload.selectedMethod)})),await a.getInitialConfig(),await o.getCart(),this.allowedMethods=this.getAllowedMethods(),await Promise.all(Object.values(this.allowedMethods).map((e=>this.initApmPay(e.name)))),this.open&&await this.selectPaymentMethod()},methods:{...a(o,["getEnvironment","mapAddress","makePayment","mapSelectedAddress"]),async selectPaymentMethod(e){this.selectedMethod=e;(await window.geneCheckout.helpers.loadFromCheckout("stores.usePaymentStore")).selectPaymentMethod(e)},getAllowedMethods(){const e=this.apm.allowedPayments,t={};return e.forEach((e=>{t[e.value]={title:e.label,name:e.value,prefixedName:"ppcp_"+e.value,isAvailable:!0}})),this.allowedMethods=t,t},async initApmPay(t){const[a,o]=await window.geneCheckout.helpers.loadFromCheckout(["stores.useConfigStore","stores.useCartStore"]),s=this,n={...{sandboxClientId:this.sandboxClientId,productionClientId:this.productionClientId,pageType:"checkout",environment:this.environment,commit:!0,amount:o.cart.prices.grand_total.value,buyerCountry:this.buyerCountry,currency:a.currencyCode},...{createOrder:()=>this.createOrder(t,s),onApprove:()=>this.onApprove(s),onClick:()=>this.onClick(),onCancel:()=>this.onCancel(),onError:e=>this.onError(e),isPaymentMethodAvailable:(e,t)=>this.isPaymentMethodAvailable(e,t)}};e.apmPayments(n,t),this.apmPaymentLoaded=!0},isPaymentMethodAvailable(e,t){document.getElementById(`paypal_${t}_method`).style.display=e?"":"none"},createOrder:async(e,t)=>{try{const a=`ppcp_apm_${e}`,o=await u(a,1);console.log(o);const s=JSON.parse(o),[n]=s;return t.orderID=n,t.orderID}catch(e){return console.error("Error during createOrder:",e),null}},onClick:async()=>{const[e,t,a,o]=await window.geneCheckout.helpers.loadFromCheckout(["stores.usePaymentStore","stores.useAgreementStore","stores.useLoadingStore","stores.useRecaptchaStore"]);e.setErrorMessage("");const s=t.validateAgreements(),n=await o.validateToken("placeOrder");return!(!s||!n)&&(a.setLoadingState(!0),!0)},onApprove:async e=>{const[t,a,o]=await window.geneCheckout.helpers.loadFromCheckout(["stores.usePaymentStore","stores.useLoadingStore","stores.useCartStore"]);return e.makePayment(o.cart.email,e.orderID,e.method,!1,e.storeMethod).then((()=>{e.redirectToSuccess()})).catch((e=>{a.setLoadingState(!1);try{window.geneCheckout.helpers.handleServiceError(e)}catch(e){t.setErrorMessage(e)}}))},onCancel:async()=>{(await window.geneCheckout.helpers.loadFromCheckout(["stores.useLoadingStore"])).setLoadingState(!1)},onError:async e=>{const[t,a]=await window.geneCheckout.helpers.loadFromCheckout(["stores.usePaymentStore","stores.useLoadingStore"]);a.setLoadingState(!1),t.setErrorMessage(e)},redirectToSuccess(){window.location.href=window.geneCheckout.helpers.getSuccessPageUrl()}}};const g=["id"],w=["onClick","onKeydown"],P=["id"],C={class:"actions-toolbar","data-bind":"css: {'ppcp-disabled': !isPlaceOrderActionAllowed()}"},M=["id"],v=["id"],k={class:"recaptcha"};y.render=function(e,t,a,o,u,y){return i(!0),s(r,null,n(u.allowedMethods,(e=>(i(),s("div",null,[e.isAvailable?(i(),s("div",{key:0,id:`paypal_${e.name}_method`,style:{display:"none"},class:d([{active:u.selectedMethod===e.prefixedName},"apm-payment-container"])},[l("div",{class:d(["apm-payment-title",u.selectedMethod===e.prefixedName?"selected":""]),onClick:t=>y.selectPaymentMethod(e.prefixedName),onKeydown:t=>y.selectPaymentMethod(e.prefixedName)},[(i(),c(p(u.RadioButton),{id:`paypal_${e.name}_select`,text:e.title,checked:u.selectedMethod===e.prefixedName,"data-cy":"apm-payment-radio",class:"apm-payment-radio",onClick:t=>y.selectPaymentMethod(e.prefixedName),onKeydown:t=>y.selectPaymentMethod(e.prefixedName)},null,40,["id","text","checked","onClick","onKeydown"])),l("span",{id:`paypal_${e.name}_mark`},null,8,P)],42,w),u.errorMessage?(i(),c(p(u.ErrorMessage),{key:0,message:u.errorMessage,attached:!1},null,8,["message"])):m("v-if",!0),l("div",{id:"ppcp-apm-payment",style:h({display:u.selectedMethod===e.prefixedName?"block":"none"}),class:d(u.apmPaymentLoaded||u.selectedMethod!==e.prefixedName?"":"text-loading"),"data-cy":"checkout-PPCP-apm-payment"},null,6),l("div",{style:h({display:u.selectedMethod===e.prefixedName?"block":"none"}),class:"apm-payment-content"},[l("div",C,[l("div",{id:`paypal_${e.name}_fields`},null,8,M),l("div",{id:`paypal_${e.name}_button`},null,8,v)]),(i(),c(p(u.PrivacyPolicy))),l("div",k,[u.isRecaptchaVisible("placeOrder")?(i(),c(p(u.Recaptcha),{key:0,id:"placeOrder",location:"ppcpPaymentApm"})):m("v-if",!0)]),(i(),c(p(u.Agreements),{id:"ppcp-checkout-apm-payment"}))],4)],10,g)):m("v-if",!0)])))),256)},y.__file="src/components/PaymentPage/PaymentMethods/Apm/Apm.vue";export{y as default};

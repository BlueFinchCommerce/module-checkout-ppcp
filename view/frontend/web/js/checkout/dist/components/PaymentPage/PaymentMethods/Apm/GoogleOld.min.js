import{m as e,a as t,u as o,c as a,d as s,e as n,g as i,n as r,b as l,h as d,o as c}from"../../../../PpcpStore-B-COd6Yi.min.js";import{l as h}from"../../../../addScript-Ca9R_zUQ.min.js";import{c as p}from"../../../../createPPCPPaymentRest-C3ChoBSK.min.js";import{i as g}from"../../../../googlepaymark-1YVSBZ4_.min.js";var y={name:"PpcpGooglePayPayment",props:{open:{type:Boolean,required:!1}},data:()=>({isMethodSelected:!1,googlePayLoaded:!1,button:null,errorMessage:"",ErrorMessage:null,PrivacyPolicy:null,RadioButton:null,Recaptcha:null,Agreements:null,paymentEmitter:null,isPaymentMethodAvailable:null,selectedMethod:"ppcp_googlepay",method:"ppcp_googlepay",isRecaptchaVisible:()=>{},orderID:null}),computed:{...e(o,["google","environment","buyerCountry","productionClientId","sandboxClientId"]),googlePayLogo:()=>g},watch:{selectedMethod:{handler(e){null!==e&&"ppcp_googlepay"!==e&&(this.isMethodSelected=!1)},immediate:!0,deep:!0}},async mounted(){const{default:{components:{ErrorMessage:e,PrivacyPolicy:t,RadioButton:o,Recaptcha:a,Agreements:s}}}=await import(window.geneCheckout.main);this.Agreements=s,this.ErrorMessage=e,this.RadioButton=o,this.Recaptcha=a,this.PrivacyPolicy=t;const n="https://pay.google.com/gp/p/js/pay.js",i=Array.from(document.scripts).find((e=>e.src===n));if(!i){const e=document.createElement("script");e.setAttribute("src",n),document.head.appendChild(e)}},async created(){const[e,t,o,a]=await window.geneCheckout.helpers.loadFromCheckout(["stores.useRecaptchaStore","stores.usePaymentStore","stores.useConfigStore","stores.useCartStore"]);this.paymentEmitter=t.paymentEmitter,this.isPaymentMethodAvailable=t.isPaymentMethodAvailable,this.isRecaptchaVisible=e.isRecaptchaVisible,t.$subscribe((e=>{void 0!==e.payload.selectedMethod&&(this.selectedMethod=e.payload.selectedMethod)})),this.paymentEmitter.on("changePaymentMethodDisplay",(({visible:e})=>{this.paymentVisible=e})),await o.getInitialConfig(),await a.getCart(),await this.initGooglePay(),this.open&&await this.selectPaymentMethod()},methods:{...t(o,["getEnvironment","mapAddress","makePayment","mapSelectedAddress"]),async selectPaymentMethod(){this.isMethodSelected=!0,this.button&&(document.getElementById("ppcp-google-pay").appendChild(this.button),this.googlePayLoaded=!0);(await window.geneCheckout.helpers.loadFromCheckout("stores.usePaymentStore")).selectPaymentMethod("ppcp_googlepay")},async initGooglePay(){try{window.paypal_ppcp_googlepay||await this.addSdkScript();const e=await this.deviceSupported(),t=await this.createGooglePayClient(e);this.button=await this.createGooglePayButton(t)}catch(e){console.warn(e)}},async addSdkScript(){const e=await window.geneCheckout.helpers.loadFromCheckout(["stores.useConfigStore"]),t=h(),o={intent:this.google.paymentAction,currency:e.currencyCode,components:"googlepay"};return"sandbox"===this.environment?(o["buyer-country"]=this.buyerCountry,o["client-id"]=this.sandboxClientId):o["client-id"]=this.productionClientId,t("https://www.paypal.com/sdk/js",o,"ppcp_googlepay")},deviceSupported(){return new Promise(((e,t)=>{if("https:"!==window.location.protocol)return console.warn("Google Pay requires your checkout be served over HTTPS"),void t(new Error("Insecure protocol: HTTPS is required for Google Pay"));this.googlepay=window.paypal_ppcp_googlepay.Googlepay(),this.googlepay.config().then((async o=>{o.isEligible?(o.allowedPaymentMethods.forEach((e=>{e.parameters.billingAddressParameters.phoneNumberRequired=!0})),e(o)):t(new Error("Device not eligible for Google Pay"))})).catch((e=>{t(e)}))}))},createGooglePayClient(e){const t={onPaymentAuthorized:this.onPaymentAuthorized};return this.onPaymentDataChanged&&(t.onPaymentDataChanged=t=>this.onPaymentDataChanged(t,e)),this.googlePayClient=new window.google.payments.api.PaymentsClient({environment:this.getEnvironment(),paymentDataCallbacks:t}),this.googlePayClient.isReadyToPay({apiVersion:e.apiVersion,apiVersionMinor:e.apiVersionMinor,allowedPaymentMethods:e.allowedPaymentMethods}).then((t=>t.result?e:null))},createGooglePayButton(e){return this.googlePayClient.createButton({allowedPaymentMethods:e.allowedPaymentMethods,buttonColor:this.google.buttonColor.toLowerCase(),buttonType:"short",buttonSizeMode:"fill",onClick:()=>this.onClick(e)})},async onClick(e){const[t,o,a,s,n,i]=await window.geneCheckout.helpers.loadFromCheckout(["stores.useAgreementStore","stores.useCartStore","stores.useConfigStore","stores.useLoadingStore","stores.usePaymentStore","stores.useRecaptchaStore"]);n.setErrorMessage("");const r=t.validateAgreements(),l=await i.validateToken("placeOrder");if(!r||!l)return!1;const d={...e},c=["PAYMENT_AUTHORIZATION"],h=this.onPaymentDataChanged&&!o.cart.is_virtual;return h&&c.push("SHIPPING_ADDRESS","SHIPPING_OPTION"),d.allowedPaymentMethods=e.allowedPaymentMethods,d.transactionInfo={countryCode:e.countryCode,currencyCode:a.currencyCode,totalPriceStatus:"FINAL",totalPrice:(o.cartGrandTotal/100).toString()},d.merchantInfo=e.merchantInfo,d.shippingAddressRequired=h,d.shippingAddressParameters={phoneNumberRequired:h},d.emailRequired=!0,d.shippingOptionRequired=h,d.callbackIntents=c,delete d.countryCode,delete d.isEligible,s.setLoadingState(!0),this.googlePayClient.loadPaymentData(d).catch((e=>{console.warn(e)}))},async onPaymentAuthorized(e){const t=await window.geneCheckout.helpers.loadFromCheckout(["stores.useCartStore"]);return new Promise((async o=>{if(!t.cart.is_virtual&&!t.cart.shipping_addresses[0].selected_shipping_method)return void o({error:{reason:"SHIPPING_OPTION_INVALID",message:"No shipping method selected",intent:"SHIPPING_OPTION"}});const a=await this.mapAddress(e.paymentMethodData.info.billingAddress,e.email,e.paymentMethodData.info.billingAddress.phoneNumber);try{await window.geneCheckout.services.setAddressesOnCart(await this.mapSelectedAddress(t.cart.shipping_addresses[0]),a,e.email);const s=await p(this.method);[this.orderID]=JSON.parse(s);const n={orderId:this.orderID,paymentMethodData:e.paymentMethodData},i=await this.googlepay.confirmOrder(n);await this.onApprove(i,e),o({transactionState:"SUCCESS"})}catch(e){o({error:{reason:"PAYMENT_DATA_INVALID",message:e.message,intent:"PAYMENT_AUTHORIZATION"}})}}))},async onApprove(e,t){const[o,a]=await window.geneCheckout.helpers.loadFromCheckout(["stores.useLoadingStore","stores.usePaymentStore"]);if(e.liabilityShift&&"POSSIBLE"!==e.liabilityShift)throw new Error("Cannot validate payment");return this.makePayment(t.email,this.orderID,this.method,!1).then((()=>{window.location.href=window.geneCheckout.helpers.getSuccessPageUrl()})).catch((e=>{o.setLoadingState(!1);try{window.geneCheckout.helpers.handleServiceError(e)}catch(e){a.setErrorMessage(e)}}))}}};const m=["src"],u={key:1,class:"google-pay-content"},P={class:"recaptcha"};y.render=function(e,t,o,h,p,g){return c(),a("div",{class:r([{active:p.isMethodSelected},"google-pay-container"])},[s("div",{class:r(["google-pay-title",p.isMethodSelected?"selected":""]),onClick:t[0]||(t[0]=(...e)=>g.selectPaymentMethod&&g.selectPaymentMethod(...e)),onKeydown:t[1]||(t[1]=(...e)=>g.selectPaymentMethod&&g.selectPaymentMethod(...e))},[(c(),n(i(p.RadioButton),{id:"google-pay-select",text:e.google.title,checked:p.isMethodSelected,"data-cy":"google-pay-radio",class:"google-pay-radio",onClick:g.selectPaymentMethod,onKeydown:g.selectPaymentMethod},null,40,["text","checked","onClick","onKeydown"])),s("img",{width:"48px",class:"google-pay-logo",src:g.googlePayLogo,alt:"google-pay-logo"},null,8,m)],34),p.errorMessage?(c(),n(i(p.ErrorMessage),{key:0,message:p.errorMessage,attached:!1},null,8,["message"])):l("v-if",!0),s("div",{id:"ppcp-google-pay",style:d({display:p.isMethodSelected?"block":"none"}),class:r(!p.googlePayLoaded&&p.isMethodSelected?"text-loading":""),"data-cy":"checkout-PPCPGooglePay"},null,6),p.isMethodSelected?(c(),a("div",u,[(c(),n(i(p.PrivacyPolicy))),s("div",P,[p.isRecaptchaVisible("placeOrder")?(c(),n(i(p.Recaptcha),{key:0,id:"placeOrder",location:"ppcpPaymentGoogle"})):l("v-if",!0)]),(c(),n(i(p.Agreements),{id:"ppcp-checkout-google-pay"}))])):l("v-if",!0)],2)},y.__file="src/components/PaymentPage/PaymentMethods/Apm/GoogleOld.vue";export{y as default};
